<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Add your CSS styles here */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #newUserModal, #welcomeModal, #copyNotification { display: none; }
    </style>
</head>
<body>
    <div id="content">
        <div id="username"></div>
        <div id="score">Score: 0</div>

        <div id="gameTab" class="tab-content active">
            <button id="clickMeBtn">Click me!</button>
        </div>

        <div id="referralTab" class="tab-content">
            <h2>Referral System</h2>
            <p>Invite friends and earn 50 coins for each new user!</p>
            <p>Referred users: <span id="referralCount">0</span></p>
            <p>Coins earned from referrals: <span id="referralEarnings">0</span></p>
            <button id="copyReferralLinkBtn">Copy Referral Link</button>
        </div>
    </div>

    <div id="tabs">
        <button id="gameTabBtn">Game</button>
        <button id="referralTabBtn">Referral</button>
    </div>

    <div id="copyNotification">Link copied!</div>

    <div id="welcomeModal">
        <div class="modal-content">
            <h2>Welcome to the Game!</h2>
            <button id="playBtn">Play</button>
        </div>
    </div>

    <div id="newUserModal">
        <div class="modal-content">
            <h2>Welcome to the Game!</h2>
            <div id="referrerInfo">
                You were invited by: <span id="referrerUsername"></span>
                <br>You received 50 bonus points!
            </div>
            <button id="startPlayingBtn">Start Playing</button>
        </div>
    </div>

    <script>
        let userId, username, score = 0, lastClickTime = 0;
        let referrer = null;

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Initialize on page load
        window.onload = function() {
            // Get referrer from URL if it exists
            referrer = getUrlParameter('ref');
            
            // Get user data from Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                const initDataUnsafe = window.Telegram.WebApp.initDataUnsafe;
                
                if (initDataUnsafe && initDataUnsafe.user) {
                    userId = initDataUnsafe.user.id;
                    username = initDataUnsafe.user.username || 'User';
                }
            }
            
            if (userId) {
                // Save user to server
                saveUser();
            } else {
                // Show welcome modal for non-Telegram users
                document.getElementById('welcomeModal').style.display = 'block';
            }

            // Add event listeners
            document.getElementById('clickMeBtn').addEventListener('click', incrementScore);
            document.getElementById('copyReferralLinkBtn').addEventListener('click', copyReferralLink);
            document.getElementById('gameTabBtn').addEventListener('click', () => switchTab('gameTab'));
            document.getElementById('referralTabBtn').addEventListener('click', () => switchTab('referralTab'));
            document.getElementById('startPlayingBtn').addEventListener('click', startPlaying);
            document.getElementById('playBtn').addEventListener('click', startPlaying);
        };

        function saveUser() {
            fetch('/api/saveUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: userId, username, score, lastClickTime, referrer }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.isNewUser) {
                        // Show modal for new user
                        document.getElementById('newUserModal').style.display = 'block';
                        if (data.referrerUsername) {
                            document.getElementById('referrerInfo').style.display = 'block';
                            document.getElementById('referrerUsername').textContent = data.referrerUsername;
                        } else {
                            document.getElementById('referrerInfo').style.display = 'none';
                        }
                    }
                    // Update user data
                    updateUserData(data.user);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function updateUserData(userData) {
            score = userData.score;
            lastClickTime = userData.lastClickTime;
            document.getElementById('score').textContent = `Score: ${score}`;
            document.getElementById('username').textContent = userData.username;
        }

        function startPlaying() {
            document.getElementById('newUserModal').style.display = 'none';
            document.getElementById('welcomeModal').style.display = 'none';
            switchTab('gameTab');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'referralTab') {
                updateReferralInfo();
            }
        }

        function incrementScore() {
            score++;
            document.getElementById('score').textContent = `Score: ${score}`;
            lastClickTime = Date.now();
            saveUser();
        }

        function copyReferralLink() {
            const referralLink = `https://your-app-url.com?ref=${userId}`;
            navigator.clipboard.writeText(referralLink).then(() => {
                document.getElementById('copyNotification').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('copyNotification').style.display = 'none';
                }, 2000);
            });
        }

        function updateReferralInfo() {
            fetch(`/api/getReferralInfo/${userId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('referralCount').textContent = data.referralCount;
                document.getElementById('referralEarnings').textContent = data.referralEarnings;
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
